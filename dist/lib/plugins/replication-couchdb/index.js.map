{"version":3,"file":"index.js","names":["RxCouchDBReplicationState","url","fetch","replicationIdentifierHash","collection","pull","push","live","retryTime","autoStart","RxReplicationState","replicateCouchDB","options","addRxPlugin","RxDBLeaderElectionPlugin","endsWith","newRxError","args","name","flatClone","waitForLeadership","pullStream$","Subject","replicationPrimitivesPull","handler","lastPulledCheckpoint","batchSize","mergeUrlQueryParams","style","feed","include_docs","since","sequence","heartbeat","limit","seq_interval","response","replicationState","jsonResponse","json","results","documents","map","row","couchDBDocToRxDocData","schema","primaryPath","ensureNotFalsy","doc","checkpoint","last_seq","modifier","stream$","asObservable","replicationPrimitivesPush","revisionByCallId","Map","rows","meta","body","docs","sendDoc","newDocumentState","assumedMasterState","_rev","couchSwapPrimaryToId","method","headers","JSON","stringify","responseJson","revisions","filter","ok","forEach","set","id","rev","size","callId","conflicts","isConflict","error","length","getConflictDocsUrl","keys","c","conflictResponse","conflictResponseJson","conflictResponseRows","conflictDocsMasterState","r","getDefaultFetch","COUCHDB_NEW_REPLICATION_PLUGIN_IDENTITY_PREFIX","database","hashFunction","startBefore","start","bind","startResult","metaInstance","bulkWriteBefore","bulkWrite","writeRows","context","startsWith","lastOfArray","split","getFromMapOrThrow","delete","docId","document","itemId","data","revision","isStopped","err","errorToPlainJson","promiseWait","next","startReplicationOnLeaderShip"],"sources":["../../../../src/plugins/replication-couchdb/index.ts"],"sourcesContent":["/**\n * This plugin can be used to sync collections with a remote CouchDB endpoint.\n */\nimport {\n    ensureNotFalsy,\n    errorToPlainJson,\n    flatClone,\n    getFromMapOrThrow,\n    lastOfArray\n} from '../../plugins/utils';\n\nimport { RxDBLeaderElectionPlugin } from '../leader-election';\nimport type {\n    RxCollection,\n    ReplicationPullOptions,\n    ReplicationPushOptions,\n    RxReplicationWriteToMasterRow,\n    RxReplicationPullStreamItem,\n    CouchdbChangesResult,\n    CouchBulkDocResultRow,\n    CouchAllDocsResponse,\n    RxReplicationWriteToMasterMeta\n} from '../../types';\nimport {\n    RxReplicationState,\n    startReplicationOnLeaderShip\n} from '../replication';\nimport {\n    addRxPlugin,\n    newRxError,\n    WithDeleted\n} from '../../index';\n\nimport { Subject } from 'rxjs';\nimport type {\n    CouchDBCheckpointType,\n    FetchMethodType,\n    SyncOptionsCouchDB\n} from './couchdb-types';\nimport {\n    couchDBDocToRxDocData,\n    COUCHDB_NEW_REPLICATION_PLUGIN_IDENTITY_PREFIX,\n    mergeUrlQueryParams,\n    couchSwapPrimaryToId,\n    getDefaultFetch\n} from './couchdb-helper';\n\nexport * from './couchdb-helper';\nexport * from './couchdb-types';\n\nexport class RxCouchDBReplicationState<RxDocType> extends RxReplicationState<RxDocType, CouchDBCheckpointType> {\n    constructor(\n        public readonly url: string,\n        public fetch: FetchMethodType,\n        public readonly replicationIdentifierHash: string,\n        public readonly collection: RxCollection<RxDocType>,\n        public readonly pull?: ReplicationPullOptions<RxDocType, CouchDBCheckpointType>,\n        public readonly push?: ReplicationPushOptions<RxDocType>,\n        public readonly live: boolean = true,\n        public retryTime: number = 1000 * 5,\n        public autoStart: boolean = true\n    ) {\n        super(\n            replicationIdentifierHash,\n            collection,\n            '_deleted',\n            pull,\n            push,\n            live,\n            retryTime,\n            autoStart\n        );\n    }\n}\n\nexport function replicateCouchDB<RxDocType>(\n    options: SyncOptionsCouchDB<RxDocType>\n) {\n    const collection = options.collection;\n    addRxPlugin(RxDBLeaderElectionPlugin);\n\n    if (!options.url.endsWith('/')) {\n        throw newRxError('RC_COUCHDB_1', {\n            args: {\n                collection: options.collection.name,\n                url: options.url\n            }\n        });\n    }\n\n    options = flatClone(options);\n    if (!options.url.endsWith('/')) {\n        options.url = options.url + '/';\n    }\n    options.waitForLeadership = typeof options.waitForLeadership === 'undefined' ? true : options.waitForLeadership;\n    const pullStream$: Subject<RxReplicationPullStreamItem<RxDocType, CouchDBCheckpointType>> = new Subject();\n    let replicationPrimitivesPull: ReplicationPullOptions<RxDocType, CouchDBCheckpointType> | undefined;\n    if (options.pull) {\n        replicationPrimitivesPull = {\n            async handler(\n                lastPulledCheckpoint: CouchDBCheckpointType | undefined,\n                batchSize: number\n            ) {\n                /**\n                 * @link https://docs.couchdb.org/en/3.2.2-docs/api/database/changes.html\n                 */\n                const url = options.url + '_changes?' + mergeUrlQueryParams({\n                    style: 'all_docs',\n                    feed: 'normal',\n                    include_docs: true,\n                    since: lastPulledCheckpoint ? lastPulledCheckpoint.sequence : 0,\n                    heartbeat: options.pull && options.pull.heartbeat ? options.pull.heartbeat : 60000,\n                    limit: batchSize,\n                    seq_interval: batchSize\n                });\n\n                const response = await replicationState.fetch(url);\n                const jsonResponse: CouchdbChangesResult = await response.json();\n                if (!jsonResponse.results) {\n                    throw newRxError('RC_COUCHDB_2', {\n                        args: { jsonResponse }\n                    });\n                }\n                const documents: WithDeleted<RxDocType>[] = jsonResponse.results\n                    .map(row => couchDBDocToRxDocData(collection.schema.primaryPath, ensureNotFalsy(row.doc)));\n                return {\n                    documents,\n                    checkpoint: {\n                        sequence: jsonResponse.last_seq\n                    }\n                };\n            },\n            batchSize: ensureNotFalsy(options.pull).batchSize,\n            modifier: ensureNotFalsy(options.pull).modifier,\n            stream$: pullStream$.asObservable()\n        };\n    }\n\n    let replicationPrimitivesPush: ReplicationPushOptions<RxDocType> | undefined;\n    const revisionByCallId: Map<string, Map<string, string>> = new Map();\n    if (options.push) {\n        replicationPrimitivesPush = {\n            async handler(\n                rows: RxReplicationWriteToMasterRow<RxDocType>[],\n                meta: RxReplicationWriteToMasterMeta\n            ) {\n                /**\n                 * @link https://docs.couchdb.org/en/3.2.2-docs/api/database/bulk-api.html#db-bulk-docs\n                 */\n                const url = options.url + '_bulk_docs?' + mergeUrlQueryParams({});\n                const body = {\n                    docs: rows.map(row => {\n                        const sendDoc = flatClone(row.newDocumentState);\n                        if (row.assumedMasterState) {\n                            (sendDoc as any)._rev = ensureNotFalsy((row.assumedMasterState as any)._rev);\n                        }\n                        return couchSwapPrimaryToId(collection.schema.primaryPath, sendDoc);\n                    })\n                };\n\n                const response = await replicationState.fetch(\n                    url,\n                    {\n                        method: 'POST',\n                        headers: {\n                            'content-type': 'application/json'\n                        },\n                        body: JSON.stringify(body)\n                    }\n                );\n                const responseJson: CouchBulkDocResultRow[] = await response.json();\n\n                /**\n                 * CouchDB creates the new document revision\n                 * and we have to remember it here so that\n                 * we can later inject them into the assumedMasterState\n                 * of the meta storage instance.\n                 */\n                const revisions = new Map<string, string>();\n                responseJson\n                    .filter(row => row.ok)\n                    .forEach(row => revisions.set(row.id, row.rev));\n                if (revisions.size > 0) {\n                    revisionByCallId.set(meta.callId, revisions);\n                }\n\n\n                // get conflicting writes\n                const conflicts = responseJson.filter(row => {\n                    const isConflict = row.error === 'conflict';\n                    if (!row.ok && !isConflict) {\n                        throw newRxError('SNH', { args: { row } });\n                    }\n                    return isConflict;\n                });\n\n                if (conflicts.length === 0) {\n                    return [];\n                }\n\n                const getConflictDocsUrl = options.url + '_all_docs?' + mergeUrlQueryParams({\n                    include_docs: true,\n                    keys: JSON.stringify(conflicts.map(c => c.id))\n                });\n                const conflictResponse = await replicationState.fetch(getConflictDocsUrl);\n                const conflictResponseJson: CouchAllDocsResponse = await conflictResponse.json();\n                const conflictResponseRows = conflictResponseJson.rows;\n                const conflictDocsMasterState: WithDeleted<RxDocType>[] = conflictResponseRows\n                    .map(r => couchDBDocToRxDocData(collection.schema.primaryPath, r.doc));\n\n                return conflictDocsMasterState;\n            },\n            batchSize: options.push.batchSize,\n            modifier: options.push.modifier\n        };\n    }\n\n    const replicationState = new RxCouchDBReplicationState<RxDocType>(\n        options.url,\n        options.fetch ? options.fetch : getDefaultFetch(),\n        COUCHDB_NEW_REPLICATION_PLUGIN_IDENTITY_PREFIX + options.collection.database.hashFunction(options.url),\n        collection,\n        replicationPrimitivesPull,\n        replicationPrimitivesPush,\n        options.live,\n        options.retryTime,\n        options.autoStart\n    );\n\n    /**\n     * Wrap the meta instance to make it store\n     * the server-side generated revisions from CouchDB\n     * so that the assumedMasterState contains the correct _rev value.\n     */\n    if (options.push) {\n        const startBefore = replicationState.start.bind(replicationState);\n        replicationState.start = async () => {\n            const startResult = await startBefore();\n            const metaInstance = ensureNotFalsy(replicationState.metaInstance);\n            const bulkWriteBefore = metaInstance.bulkWrite.bind(metaInstance);\n            metaInstance.bulkWrite = function (writeRows, context) {\n                if (context.startsWith('replication-up-write-meta')) {\n                    const callId = ensureNotFalsy(lastOfArray(context.split('-')));\n                    const revisions = getFromMapOrThrow(revisionByCallId, callId);\n                    revisionByCallId.delete(callId);\n                    writeRows.forEach(row => {\n                        const docId = row.document.itemId;\n                        row.document.data = flatClone(row.document.data);\n                        const revision = getFromMapOrThrow(revisions, docId);\n                        row.document.data._rev = revision;\n                    });\n                }\n                return bulkWriteBefore(writeRows, context);\n            };\n            return startResult;\n        };\n\n    }\n\n\n    /**\n     * Use long polling to get live changes for the pull.stream$\n     */\n    if (options.live && options.pull) {\n        const startBefore = replicationState.start.bind(replicationState);\n        replicationState.start = () => {\n            let since: string | number = 'now';\n            const batchSize = options.pull && options.pull.batchSize ? options.pull.batchSize : 20;\n\n            (async () => {\n                while (!replicationState.isStopped()) {\n                    const url = options.url + '_changes?' + mergeUrlQueryParams({\n                        style: 'all_docs',\n                        feed: 'longpoll',\n                        since,\n                        include_docs: true,\n                        heartbeat: options.pull && options.pull.heartbeat ? options.pull.heartbeat : 60000,\n                        limit: batchSize,\n                        seq_interval: batchSize\n                    });\n\n                    let jsonResponse: CouchdbChangesResult;\n                    try {\n                        jsonResponse = await (await replicationState.fetch(url)).json();\n                    } catch (err: any) {\n                        pullStream$.error(newRxError('RC_STREAM', {\n                            args: { url },\n                            error: errorToPlainJson(err)\n                        }));\n                        // await next tick here otherwise we could go in to a 100% CPU blocking cycle.\n                        await collection.promiseWait(0);\n                        continue;\n                    }\n                    const documents: WithDeleted<RxDocType>[] = jsonResponse.results\n                        .map(row => couchDBDocToRxDocData(collection.schema.primaryPath, ensureNotFalsy(row.doc)));\n                    since = jsonResponse.last_seq;\n\n                    pullStream$.next({\n                        documents,\n                        checkpoint: {\n                            sequence: jsonResponse.last_seq\n                        }\n                    });\n                }\n            })();\n            return startBefore();\n        };\n    }\n\n    startReplicationOnLeaderShip(options.waitForLeadership, replicationState);\n\n    return replicationState;\n}\n"],"mappings":";;;;;;;;;;;;;AAGA;AAQA;AAYA;AAIA;AAMA;AAMA;AAQA;EAAA;EAAA;EAAA;EAAA;IAAA;IAAA;MAAA;IAAA;EAAA;AAAA;AACA;AAAA;EAAA;EAAA;EAAA;EAAA;IAAA;IAAA;MAAA;IAAA;EAAA;AAAA;AAhDA;AACA;AACA;AAFA,IAkDaA,yBAAyB;EAAA;EAClC,mCACoBC,GAAW,EACpBC,KAAsB,EACbC,yBAAiC,EACjCC,UAAmC,EACnCC,IAA+D,EAC/DC,IAAwC,EACxCC,IAAa,GAAG,IAAI,EAC7BC,SAAiB,GAAG,IAAI,GAAG,CAAC,EAC5BC,SAAkB,GAAG,IAAI,EAClC;IAAA;IACE,uCACIN,yBAAyB,EACzBC,UAAU,EACV,UAAU,EACVC,IAAI,EACJC,IAAI,EACJC,IAAI,EACJC,SAAS,EACTC,SAAS,CACZ;IAAC,MAnBcR,GAAW,GAAXA,GAAW;IAAA,MACpBC,KAAsB,GAAtBA,KAAsB;IAAA,MACbC,yBAAiC,GAAjCA,yBAAiC;IAAA,MACjCC,UAAmC,GAAnCA,UAAmC;IAAA,MACnCC,IAA+D,GAA/DA,IAA+D;IAAA,MAC/DC,IAAwC,GAAxCA,IAAwC;IAAA,MACxCC,IAAa,GAAbA,IAAa;IAAA,MACtBC,SAAiB,GAAjBA,SAAiB;IAAA,MACjBC,SAAkB,GAAlBA,SAAkB;IAAA;EAY7B;EAAC;AAAA,EAtBqDC,+BAAkB;AAAA;AAyBrE,SAASC,gBAAgB,CAC5BC,OAAsC,EACxC;EACE,IAAMR,UAAU,GAAGQ,OAAO,CAACR,UAAU;EACrC,IAAAS,kBAAW,EAACC,wCAAwB,CAAC;EAErC,IAAI,CAACF,OAAO,CAACX,GAAG,CAACc,QAAQ,CAAC,GAAG,CAAC,EAAE;IAC5B,MAAM,IAAAC,iBAAU,EAAC,cAAc,EAAE;MAC7BC,IAAI,EAAE;QACFb,UAAU,EAAEQ,OAAO,CAACR,UAAU,CAACc,IAAI;QACnCjB,GAAG,EAAEW,OAAO,CAACX;MACjB;IACJ,CAAC,CAAC;EACN;EAEAW,OAAO,GAAG,IAAAO,gBAAS,EAACP,OAAO,CAAC;EAC5B,IAAI,CAACA,OAAO,CAACX,GAAG,CAACc,QAAQ,CAAC,GAAG,CAAC,EAAE;IAC5BH,OAAO,CAACX,GAAG,GAAGW,OAAO,CAACX,GAAG,GAAG,GAAG;EACnC;EACAW,OAAO,CAACQ,iBAAiB,GAAG,OAAOR,OAAO,CAACQ,iBAAiB,KAAK,WAAW,GAAG,IAAI,GAAGR,OAAO,CAACQ,iBAAiB;EAC/G,IAAMC,WAAmF,GAAG,IAAIC,aAAO,EAAE;EACzG,IAAIC,yBAA+F;EACnG,IAAIX,OAAO,CAACP,IAAI,EAAE;IACdkB,yBAAyB,GAAG;MACxB,MAAMC,OAAO,CACTC,oBAAuD,EACvDC,SAAiB,EACnB;QACE;AAChB;AACA;QACgB,IAAMzB,GAAG,GAAGW,OAAO,CAACX,GAAG,GAAG,WAAW,GAAG,IAAA0B,kCAAmB,EAAC;UACxDC,KAAK,EAAE,UAAU;UACjBC,IAAI,EAAE,QAAQ;UACdC,YAAY,EAAE,IAAI;UAClBC,KAAK,EAAEN,oBAAoB,GAAGA,oBAAoB,CAACO,QAAQ,GAAG,CAAC;UAC/DC,SAAS,EAAErB,OAAO,CAACP,IAAI,IAAIO,OAAO,CAACP,IAAI,CAAC4B,SAAS,GAAGrB,OAAO,CAACP,IAAI,CAAC4B,SAAS,GAAG,KAAK;UAClFC,KAAK,EAAER,SAAS;UAChBS,YAAY,EAAET;QAClB,CAAC,CAAC;QAEF,IAAMU,QAAQ,GAAG,MAAMC,gBAAgB,CAACnC,KAAK,CAACD,GAAG,CAAC;QAClD,IAAMqC,YAAkC,GAAG,MAAMF,QAAQ,CAACG,IAAI,EAAE;QAChE,IAAI,CAACD,YAAY,CAACE,OAAO,EAAE;UACvB,MAAM,IAAAxB,iBAAU,EAAC,cAAc,EAAE;YAC7BC,IAAI,EAAE;cAAEqB;YAAa;UACzB,CAAC,CAAC;QACN;QACA,IAAMG,SAAmC,GAAGH,YAAY,CAACE,OAAO,CAC3DE,GAAG,CAACC,GAAG,IAAI,IAAAC,oCAAqB,EAACxC,UAAU,CAACyC,MAAM,CAACC,WAAW,EAAE,IAAAC,qBAAc,EAACJ,GAAG,CAACK,GAAG,CAAC,CAAC,CAAC;QAC9F,OAAO;UACHP,SAAS;UACTQ,UAAU,EAAE;YACRjB,QAAQ,EAAEM,YAAY,CAACY;UAC3B;QACJ,CAAC;MACL,CAAC;MACDxB,SAAS,EAAE,IAAAqB,qBAAc,EAACnC,OAAO,CAACP,IAAI,CAAC,CAACqB,SAAS;MACjDyB,QAAQ,EAAE,IAAAJ,qBAAc,EAACnC,OAAO,CAACP,IAAI,CAAC,CAAC8C,QAAQ;MAC/CC,OAAO,EAAE/B,WAAW,CAACgC,YAAY;IACrC,CAAC;EACL;EAEA,IAAIC,yBAAwE;EAC5E,IAAMC,gBAAkD,GAAG,IAAIC,GAAG,EAAE;EACpE,IAAI5C,OAAO,CAACN,IAAI,EAAE;IACdgD,yBAAyB,GAAG;MACxB,MAAM9B,OAAO,CACTiC,IAAgD,EAChDC,IAAoC,EACtC;QACE;AAChB;AACA;QACgB,IAAMzD,GAAG,GAAGW,OAAO,CAACX,GAAG,GAAG,aAAa,GAAG,IAAA0B,kCAAmB,EAAC,CAAC,CAAC,CAAC;QACjE,IAAMgC,IAAI,GAAG;UACTC,IAAI,EAAEH,IAAI,CAACf,GAAG,CAACC,GAAG,IAAI;YAClB,IAAMkB,OAAO,GAAG,IAAA1C,gBAAS,EAACwB,GAAG,CAACmB,gBAAgB,CAAC;YAC/C,IAAInB,GAAG,CAACoB,kBAAkB,EAAE;cACvBF,OAAO,CAASG,IAAI,GAAG,IAAAjB,qBAAc,EAAEJ,GAAG,CAACoB,kBAAkB,CAASC,IAAI,CAAC;YAChF;YACA,OAAO,IAAAC,mCAAoB,EAAC7D,UAAU,CAACyC,MAAM,CAACC,WAAW,EAAEe,OAAO,CAAC;UACvE,CAAC;QACL,CAAC;QAED,IAAMzB,QAAQ,GAAG,MAAMC,gBAAgB,CAACnC,KAAK,CACzCD,GAAG,EACH;UACIiE,MAAM,EAAE,MAAM;UACdC,OAAO,EAAE;YACL,cAAc,EAAE;UACpB,CAAC;UACDR,IAAI,EAAES,IAAI,CAACC,SAAS,CAACV,IAAI;QAC7B,CAAC,CACJ;QACD,IAAMW,YAAqC,GAAG,MAAMlC,QAAQ,CAACG,IAAI,EAAE;;QAEnE;AAChB;AACA;AACA;AACA;AACA;QACgB,IAAMgC,SAAS,GAAG,IAAIf,GAAG,EAAkB;QAC3Cc,YAAY,CACPE,MAAM,CAAC7B,GAAG,IAAIA,GAAG,CAAC8B,EAAE,CAAC,CACrBC,OAAO,CAAC/B,GAAG,IAAI4B,SAAS,CAACI,GAAG,CAAChC,GAAG,CAACiC,EAAE,EAAEjC,GAAG,CAACkC,GAAG,CAAC,CAAC;QACnD,IAAIN,SAAS,CAACO,IAAI,GAAG,CAAC,EAAE;UACpBvB,gBAAgB,CAACoB,GAAG,CAACjB,IAAI,CAACqB,MAAM,EAAER,SAAS,CAAC;QAChD;;QAGA;QACA,IAAMS,SAAS,GAAGV,YAAY,CAACE,MAAM,CAAC7B,GAAG,IAAI;UACzC,IAAMsC,UAAU,GAAGtC,GAAG,CAACuC,KAAK,KAAK,UAAU;UAC3C,IAAI,CAACvC,GAAG,CAAC8B,EAAE,IAAI,CAACQ,UAAU,EAAE;YACxB,MAAM,IAAAjE,iBAAU,EAAC,KAAK,EAAE;cAAEC,IAAI,EAAE;gBAAE0B;cAAI;YAAE,CAAC,CAAC;UAC9C;UACA,OAAOsC,UAAU;QACrB,CAAC,CAAC;QAEF,IAAID,SAAS,CAACG,MAAM,KAAK,CAAC,EAAE;UACxB,OAAO,EAAE;QACb;QAEA,IAAMC,kBAAkB,GAAGxE,OAAO,CAACX,GAAG,GAAG,YAAY,GAAG,IAAA0B,kCAAmB,EAAC;UACxEG,YAAY,EAAE,IAAI;UAClBuD,IAAI,EAAEjB,IAAI,CAACC,SAAS,CAACW,SAAS,CAACtC,GAAG,CAAC4C,CAAC,IAAIA,CAAC,CAACV,EAAE,CAAC;QACjD,CAAC,CAAC;QACF,IAAMW,gBAAgB,GAAG,MAAMlD,gBAAgB,CAACnC,KAAK,CAACkF,kBAAkB,CAAC;QACzE,IAAMI,oBAA0C,GAAG,MAAMD,gBAAgB,CAAChD,IAAI,EAAE;QAChF,IAAMkD,oBAAoB,GAAGD,oBAAoB,CAAC/B,IAAI;QACtD,IAAMiC,uBAAiD,GAAGD,oBAAoB,CACzE/C,GAAG,CAACiD,CAAC,IAAI,IAAA/C,oCAAqB,EAACxC,UAAU,CAACyC,MAAM,CAACC,WAAW,EAAE6C,CAAC,CAAC3C,GAAG,CAAC,CAAC;QAE1E,OAAO0C,uBAAuB;MAClC,CAAC;MACDhE,SAAS,EAAEd,OAAO,CAACN,IAAI,CAACoB,SAAS;MACjCyB,QAAQ,EAAEvC,OAAO,CAACN,IAAI,CAAC6C;IAC3B,CAAC;EACL;EAEA,IAAMd,gBAAgB,GAAG,IAAIrC,yBAAyB,CAClDY,OAAO,CAACX,GAAG,EACXW,OAAO,CAACV,KAAK,GAAGU,OAAO,CAACV,KAAK,GAAG,IAAA0F,8BAAe,GAAE,EACjDC,6DAA8C,GAAGjF,OAAO,CAACR,UAAU,CAAC0F,QAAQ,CAACC,YAAY,CAACnF,OAAO,CAACX,GAAG,CAAC,EACtGG,UAAU,EACVmB,yBAAyB,EACzB+B,yBAAyB,EACzB1C,OAAO,CAACL,IAAI,EACZK,OAAO,CAACJ,SAAS,EACjBI,OAAO,CAACH,SAAS,CACpB;;EAED;AACJ;AACA;AACA;AACA;EACI,IAAIG,OAAO,CAACN,IAAI,EAAE;IACd,IAAM0F,WAAW,GAAG3D,gBAAgB,CAAC4D,KAAK,CAACC,IAAI,CAAC7D,gBAAgB,CAAC;IACjEA,gBAAgB,CAAC4D,KAAK,GAAG,YAAY;MACjC,IAAME,WAAW,GAAG,MAAMH,WAAW,EAAE;MACvC,IAAMI,YAAY,GAAG,IAAArD,qBAAc,EAACV,gBAAgB,CAAC+D,YAAY,CAAC;MAClE,IAAMC,eAAe,GAAGD,YAAY,CAACE,SAAS,CAACJ,IAAI,CAACE,YAAY,CAAC;MACjEA,YAAY,CAACE,SAAS,GAAG,UAAUC,SAAS,EAAEC,OAAO,EAAE;QACnD,IAAIA,OAAO,CAACC,UAAU,CAAC,2BAA2B,CAAC,EAAE;UACjD,IAAM1B,MAAM,GAAG,IAAAhC,qBAAc,EAAC,IAAA2D,kBAAW,EAACF,OAAO,CAACG,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC;UAC9D,IAAMpC,SAAS,GAAG,IAAAqC,wBAAiB,EAACrD,gBAAgB,EAAEwB,MAAM,CAAC;UAC7DxB,gBAAgB,CAACsD,MAAM,CAAC9B,MAAM,CAAC;UAC/BwB,SAAS,CAAC7B,OAAO,CAAC/B,GAAG,IAAI;YACrB,IAAMmE,KAAK,GAAGnE,GAAG,CAACoE,QAAQ,CAACC,MAAM;YACjCrE,GAAG,CAACoE,QAAQ,CAACE,IAAI,GAAG,IAAA9F,gBAAS,EAACwB,GAAG,CAACoE,QAAQ,CAACE,IAAI,CAAC;YAChD,IAAMC,QAAQ,GAAG,IAAAN,wBAAiB,EAACrC,SAAS,EAAEuC,KAAK,CAAC;YACpDnE,GAAG,CAACoE,QAAQ,CAACE,IAAI,CAACjD,IAAI,GAAGkD,QAAQ;UACrC,CAAC,CAAC;QACN;QACA,OAAOb,eAAe,CAACE,SAAS,EAAEC,OAAO,CAAC;MAC9C,CAAC;MACD,OAAOL,WAAW;IACtB,CAAC;EAEL;;EAGA;AACJ;AACA;EACI,IAAIvF,OAAO,CAACL,IAAI,IAAIK,OAAO,CAACP,IAAI,EAAE;IAC9B,IAAM2F,YAAW,GAAG3D,gBAAgB,CAAC4D,KAAK,CAACC,IAAI,CAAC7D,gBAAgB,CAAC;IACjEA,gBAAgB,CAAC4D,KAAK,GAAG,MAAM;MAC3B,IAAIlE,KAAsB,GAAG,KAAK;MAClC,IAAML,SAAS,GAAGd,OAAO,CAACP,IAAI,IAAIO,OAAO,CAACP,IAAI,CAACqB,SAAS,GAAGd,OAAO,CAACP,IAAI,CAACqB,SAAS,GAAG,EAAE;MAEtF,CAAC,YAAY;QACT,OAAO,CAACW,gBAAgB,CAAC8E,SAAS,EAAE,EAAE;UAClC,IAAMlH,IAAG,GAAGW,OAAO,CAACX,GAAG,GAAG,WAAW,GAAG,IAAA0B,kCAAmB,EAAC;YACxDC,KAAK,EAAE,UAAU;YACjBC,IAAI,EAAE,UAAU;YAChBE,KAAK;YACLD,YAAY,EAAE,IAAI;YAClBG,SAAS,EAAErB,OAAO,CAACP,IAAI,IAAIO,OAAO,CAACP,IAAI,CAAC4B,SAAS,GAAGrB,OAAO,CAACP,IAAI,CAAC4B,SAAS,GAAG,KAAK;YAClFC,KAAK,EAAER,SAAS;YAChBS,YAAY,EAAET;UAClB,CAAC,CAAC;UAEF,IAAIY,YAAkC;UACtC,IAAI;YACAA,YAAY,GAAG,MAAM,CAAC,MAAMD,gBAAgB,CAACnC,KAAK,CAACD,IAAG,CAAC,EAAEsC,IAAI,EAAE;UACnE,CAAC,CAAC,OAAO6E,GAAQ,EAAE;YACf/F,WAAW,CAAC6D,KAAK,CAAC,IAAAlE,iBAAU,EAAC,WAAW,EAAE;cACtCC,IAAI,EAAE;gBAAEhB,GAAG,EAAHA;cAAI,CAAC;cACbiF,KAAK,EAAE,IAAAmC,uBAAgB,EAACD,GAAG;YAC/B,CAAC,CAAC,CAAC;YACH;YACA,MAAMhH,UAAU,CAACkH,WAAW,CAAC,CAAC,CAAC;YAC/B;UACJ;UACA,IAAM7E,SAAmC,GAAGH,YAAY,CAACE,OAAO,CAC3DE,GAAG,CAACC,GAAG,IAAI,IAAAC,oCAAqB,EAACxC,UAAU,CAACyC,MAAM,CAACC,WAAW,EAAE,IAAAC,qBAAc,EAACJ,GAAG,CAACK,GAAG,CAAC,CAAC,CAAC;UAC9FjB,KAAK,GAAGO,YAAY,CAACY,QAAQ;UAE7B7B,WAAW,CAACkG,IAAI,CAAC;YACb9E,SAAS;YACTQ,UAAU,EAAE;cACRjB,QAAQ,EAAEM,YAAY,CAACY;YAC3B;UACJ,CAAC,CAAC;QACN;MACJ,CAAC,GAAG;MACJ,OAAO8C,YAAW,EAAE;IACxB,CAAC;EACL;EAEA,IAAAwB,yCAA4B,EAAC5G,OAAO,CAACQ,iBAAiB,EAAEiB,gBAAgB,CAAC;EAEzE,OAAOA,gBAAgB;AAC3B"}